<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>íšŒì›ê°€ì… - NeuroTune</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fjalla+One&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="../assets/css/common.css" />
    <style>
      .signup-page {
        position: fixed;
        inset: 0;
        background-color: var(--color-bg);
        overflow-y: auto;
        overflow-x: hidden;
      }

      .bg-logo-icon {
        position: fixed;
        width: 55vw;
        height: auto;
        top: -10vh;
        left: -10vw;
        transform: rotate(26.78deg);
        opacity: 0.5;
        pointer-events: none;
        user-select: none;
        z-index: 0;
      }

      .signup-content {
        position: relative;
        width: 100%;
        min-height: 100vh;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
      }

      .signup-title {
        margin: 0 16px 16px;
        color: var(--color-dark);
        font-size: 32px;
        font-weight: 700;
        letter-spacing: -0.07em;
        text-align: center;
      }

      .signup-subtitle {
        margin: 0 0 40px 0;
        color: var(--color-text-gray);
        font-size: 16px;
        text-align: center;
        max-width: 600px;
      }

      .signup-form {
        width: 100%;
        max-width: 600px;
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 32px;
      }

      .form-section {
        margin-bottom: 32px;
        padding-bottom: 32px;
        border-bottom: 1px solid var(--color-line);
      }

      .form-section:last-of-type {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--color-dark);
        margin: 0 0 20px 0;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        color: var(--color-dark);
        font-size: 14px;
        font-weight: 600;
      }

      .form-label .required {
        color: #e74c3c;
      }

      .form-help {
        display: block;
        margin-top: 4px;
        color: var(--color-text-gray);
        font-size: 12px;
      }

      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--color-line);
        border-radius: 8px;
        background-color: var(--color-bg);
        color: var(--color-dark);
        font-size: 14px;
        transition: border-color 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--color-accent-strong);
      }

      .form-input::placeholder {
        color: var(--color-text-gray);
        opacity: 0.6;
      }

      .form-input.monospace {
        font-family: monospace;
      }

      .form-input.error {
        border-color: #e74c3c;
      }

      .error-message {
        color: #e74c3c;
        font-size: 12px;
        margin-top: 4px;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .form-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 24px;
      }

      .form-actions .btn {
        width: 100%;
        padding: 14px 24px;
        font-size: 16px;
      }

      .btn-secondary {
        background-color: var(--color-line);
        color: var(--color-dark);
      }

      .btn-secondary:hover {
        background-color: var(--color-border);
      }

      .login-link {
        text-align: center;
        margin-top: 16px;
        color: var(--color-text-gray);
        font-size: 14px;
      }

      .login-link a {
        color: var(--color-dark);
        text-decoration: underline;
        font-weight: 600;
      }

      .api-info {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 20px;
      }

      .api-info-title {
        font-weight: 600;
        color: #856404;
        margin: 0 0 8px 0;
        font-size: 14px;
      }

      .api-info-text {
        color: #856404;
        margin: 0;
        font-size: 12px;
        line-height: 1.5;
      }

      .api-info-text a {
        color: #856404;
        text-decoration: underline;
      }

      .optional-badge {
        display: inline-block;
        padding: 2px 8px;
        background-color: var(--color-line);
        color: var(--color-text-gray);
        font-size: 11px;
        border-radius: 4px;
        margin-left: 8px;
        font-weight: normal;
      }
    </style>
  </head>
  <body>
    <main class="signup-page">
      <img
        src="../../logo_page/icon/neurotune_icon.png"
        alt="NeuroTune background icon"
        class="bg-logo-icon"
      />

      <section class="signup-content fade-in">
        <h1 class="signup-title">íšŒì›ê°€ì…</h1>
        <p class="signup-subtitle">
          NeuroTuneì„ ì‹œì‘í•˜ê¸° ìœ„í•´ ê³„ì •ì„ ìƒì„±í•˜ì„¸ìš”
        </p>

        <form class="signup-form" id="signupForm">
          <!-- Account Information Section -->
          <div class="form-section">
            <h2 class="section-title">ê³„ì • ì •ë³´</h2>
            
            <div class="form-group">
              <label class="form-label" for="username">
                ì•„ì´ë”” <span class="required">*</span>
              </label>
              <input
                type="text"
                class="form-input"
                id="username"
                placeholder="3-20ì ì˜ë¬¸, ìˆ«ì"
                autocomplete="off"
                required
                minlength="3"
                maxlength="20"
              />
              <span class="error-message" id="usernameError"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="password">
                ë¹„ë°€ë²ˆí˜¸ <span class="required">*</span>
              </label>
              <input
                type="password"
                class="form-input"
                id="password"
                placeholder="6ì ì´ìƒ"
                required
                minlength="6"
              />
              <span class="error-message" id="passwordError"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="passwordConfirm">
                ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span class="required">*</span>
              </label>
              <input
                type="password"
                class="form-input"
                id="passwordConfirm"
                placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥"
                required
              />
              <span class="error-message" id="passwordConfirmError"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="nickname">
                ë‹‰ë„¤ì„ <span class="required">*</span>
              </label>
              <input
                type="text"
                class="form-input"
                id="nickname"
                placeholder="í‘œì‹œë  ì´ë¦„"
                autocomplete="off"
                required
                maxlength="20"
              />
              <span class="form-help">ë‹¤ë¥¸ ì‚¬ìš©ìì—ê²Œ í‘œì‹œë  ì´ë¦„ì…ë‹ˆë‹¤</span>
            </div>
          </div>

          <!-- API Keys Section (Optional) -->
          <div class="form-section">
            <h2 class="section-title">
              API í‚¤ ì„¤ì •
              <span class="optional-badge">ì„ íƒì‚¬í•­</span>
            </h2>

            <div class="api-info">
              <p class="api-info-title">ğŸ”‘ API í‚¤ ë°œê¸‰ ë°©ë²•</p>
              <p class="api-info-text">
                â€¢ <strong>Spotify:</strong> <a href="https://developer.spotify.com/dashboard" target="_blank">developer.spotify.com</a>ì—ì„œ ì•± ìƒì„±<br />
                â€¢ <strong>MongoDB:</strong> <a href="https://www.mongodb.com/cloud/atlas" target="_blank">MongoDB Atlas</a>ì—ì„œ ë¬´ë£Œ í´ëŸ¬ìŠ¤í„° ìƒì„±<br />
                â€¢ <strong>GitHub Token:</strong> <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings</a>ì—ì„œ Personal Access Token ìƒì„± (AI ë¶„ì„ìš©, ì„ íƒ)<br />
                <br />
                <em>â€» ë‚˜ì¤‘ì— ì„¤ì • ê°€ëŠ¥í•˜ë©°, í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ë¨¼ì € ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</em>
              </p>
            </div>

            <div class="form-group">
              <label class="form-label" for="spotifyClientId">
                Spotify Client ID
              </label>
              <input
                type="text"
                class="form-input monospace"
                id="spotifyClientId"
                placeholder="your_spotify_client_id"
                autocomplete="off"
              />
              <span class="form-help">Spotify Developer Dashboardì—ì„œ í™•ì¸</span>
            </div>

            <div class="form-group">
              <label class="form-label" for="spotifyClientSecret">
                Spotify Client Secret
              </label>
              <input
                type="password"
                class="form-input monospace"
                id="spotifyClientSecret"
                placeholder="your_spotify_client_secret"
                autocomplete="off"
              />
              <span class="form-help">Spotify Developer Dashboardì—ì„œ í™•ì¸</span>
            </div>

            <div class="form-group">
              <label class="form-label" for="mongodbUri">
                MongoDB URI
              </label>
              <input
                type="text"
                class="form-input monospace"
                id="mongodbUri"
                placeholder="mongodb+srv://username:password@cluster.mongodb.net/neurotune"
                autocomplete="off"
              />
              <span class="form-help">MongoDB Atlas connection string</span>
            </div>

            <div class="form-group">
              <label class="form-label" for="copilotApiKey">
                GitHub Personal Access Token
              </label>
              <input
                type="password"
                class="form-input monospace"
                id="copilotApiKey"
                placeholder="ghp_..."
                autocomplete="off"
              />
              <span class="form-help">AI ë¶„ì„ ê¸°ëŠ¥ì— ì‚¬ìš©ë©ë‹ˆë‹¤ (GitHub API í˜¸ì¶œìš©)</span>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn" id="signupBtn">
              íšŒì›ê°€ì…
            </button>
            <button type="button" class="btn btn-secondary" id="skipBtn">
              API í‚¤ ì—†ì´ ê°€ì… (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)
            </button>
          </div>

          <div class="login-link">
            ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="02-login.html">ë¡œê·¸ì¸</a>
          </div>
        </form>
      </section>
    </main>

    <script>
      const API_BASE_URL = 'http://localhost:5000/api';
      
      const form = document.getElementById('signupForm');
      const skipBtn = document.getElementById('skipBtn');
      const signupBtn = document.getElementById('signupBtn');

      // Form validation
      const username = document.getElementById('username');
      const password = document.getElementById('password');
      const passwordConfirm = document.getElementById('passwordConfirm');
      const nickname = document.getElementById('nickname');

      function showError(inputId, message) {
        const input = document.getElementById(inputId);
        const errorElement = document.getElementById(inputId + 'Error');
        input.classList.add('error');
        errorElement.textContent = message;
        errorElement.classList.add('show');
      }

      function clearError(inputId) {
        const input = document.getElementById(inputId);
        const errorElement = document.getElementById(inputId + 'Error');
        input.classList.remove('error');
        errorElement.classList.remove('show');
      }

      function validateForm() {
        let isValid = true;

        // Clear previous errors
        clearError('username');
        clearError('password');
        clearError('passwordConfirm');

        // Validate username
        if (username.value.trim().length < 3) {
          showError('username', 'ì•„ì´ë””ëŠ” ìµœì†Œ 3ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');
          isValid = false;
        }

        // Validate password
        if (password.value.length < 6) {
          showError('password', 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');
          isValid = false;
        }

        // Validate password confirmation
        if (password.value !== passwordConfirm.value) {
          showError('passwordConfirm', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
          isValid = false;
        }

        return isValid;
      }

      async function handleSignup(testMode = false) {
        if (!validateForm()) {
          return;
        }

        signupBtn.disabled = true;
        signupBtn.textContent = 'ê°€ì… ì¤‘...';

        try {
          const apiKeys = testMode ? {
            testMode: true
          } : {
            spotifyClientId: document.getElementById('spotifyClientId').value.trim(),
            spotifyClientSecret: document.getElementById('spotifyClientSecret').value.trim(),
            mongodbUri: document.getElementById('mongodbUri').value.trim(),
            copilotApiKey: document.getElementById('copilotApiKey').value.trim(),
            testMode: false
          };

          const response = await fetch(`${API_BASE_URL}/user/register`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              username: username.value.trim(),
              password: password.value,
              nickname: nickname.value.trim(),
              apiKeys: apiKeys
            }),
          });

          const data = await response.json();

          if (data.success) {
            // Save user data to localStorage
            localStorage.setItem('neurotune_userId', data.data.userId);
            localStorage.setItem('neurotune_username', data.data.username);
            localStorage.setItem('neurotune_nickname', data.data.nickname);
            localStorage.setItem('neurotune_apiKeys', JSON.stringify(apiKeys));

            alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            window.location.href = '04-api-connect.html';
          } else {
            alert(data.message || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            signupBtn.disabled = false;
            signupBtn.textContent = 'íšŒì›ê°€ì…';
          }
        } catch (error) {
          console.error('Signup error:', error);
          alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
          signupBtn.disabled = false;
          signupBtn.textContent = 'íšŒì›ê°€ì…';
        }
      }

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        handleSignup(false);
      });

      skipBtn.addEventListener('click', () => {
        handleSignup(true);
      });

      // Real-time validation
      username.addEventListener('input', () => clearError('username'));
      password.addEventListener('input', () => clearError('password'));
      passwordConfirm.addEventListener('input', () => clearError('passwordConfirm'));
    </script>
  </body>
</html>
