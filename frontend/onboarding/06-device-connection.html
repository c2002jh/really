<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EEG 기기 연결 - NeuroTune</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fjalla+One&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="../assets/css/common.css" />
    <link rel="stylesheet" href="eeg-connection.css" />
  </head>
  <body>
    <main class="page-wrapper">
      <!-- Background icon -->
      <img
        src="../../logo_page/icon/neurotune_icon.png"
        alt="NeuroTune background icon"
        class="bg-logo-icon"
      />

      <section class="connection-content">
        <h1 class="connection-title">EEG 기기를 연결해주세요</h1>

        <!-- Device pairing animation -->
        <div class="device-animation" id="deviceAnimation">
          <div class="device-icon">
            <svg width="120" height="120" viewBox="0 0 120 120">
              <circle
                cx="60"
                cy="60"
                r="50"
                fill="none"
                stroke="var(--color-accent-strong)"
                stroke-width="3"
                opacity="0.3"
              />
              <circle
                cx="60"
                cy="60"
                r="40"
                fill="none"
                stroke="var(--color-accent-strong)"
                stroke-width="3"
                opacity="0.5"
              />
              <circle
                cx="60"
                cy="60"
                r="30"
                fill="var(--color-accent-strong)"
                opacity="0.7"
              />
            </svg>
          </div>

          <p class="connection-status" id="connectionStatus">기기 찾는 중...</p>
        </div>

        <!-- Connection button -->
        <button class="btn connect-btn" id="connectBtn">연결하기</button>
        <button class="btn connection-complete-btn" id="completeBtn" style="display: none">
          연결 완료
        </button>
      </section>
    </main>

    <script>
      const API_BASE_URL = 'http://localhost:5000/api';

      const deviceAnimation = document.getElementById('deviceAnimation');
      const connectionStatus = document.getElementById('connectionStatus');
      const connectBtn = document.getElementById('connectBtn');
      const completeBtn = document.getElementById('completeBtn');

      let isConnecting = false;
      let isConnected = false;

      // Connect button handler
      connectBtn.addEventListener('click', async () => {
        if (isConnecting) return;

        isConnecting = true;
        connectionStatus.textContent = '기기 연결 중...';
        connectBtn.disabled = true;

        // Simulate device connection (2 seconds)
        setTimeout(() => {
          isConnected = true;
          deviceAnimation.classList.add('connected');
          connectionStatus.textContent = '연결 완료!';
          connectionStatus.style.color = '#4ade80';

          // Show complete button
          connectBtn.style.display = 'none';
          completeBtn.style.display = 'block';

          isConnecting = false;
        }, 2000);
      });

      // Complete button handler
      completeBtn.addEventListener('click', async () => {
        // Get user preferences from localStorage
        const userId = localStorage.getItem('neurotune_userId') || 'anonymous';
        
        try {
          // Fetch user's preferred genres from backend
          const response = await fetch(`${API_BASE_URL}/preferences/${userId}`);
          
          if (response.ok) {
            const data = await response.json();
            const genres = data.data.genres || [];
            
            // Store genres for evaluation flow
            localStorage.setItem('neurotune_genres', JSON.stringify(genres));
            
            // Navigate to EEG data collection page
            window.location.href = '../eeg-evaluation/07-eeg-collection.html';
          } else {
            // If no preferences found, use stored genres
            const genres = JSON.parse(localStorage.getItem('neurotune_genres') || '["pop"]');
            window.location.href = '../eeg-evaluation/07-eeg-collection.html';
          }
        } catch (error) {
          console.error('Error fetching preferences:', error);
          // Fallback: proceed anyway
          window.location.href = '../eeg-evaluation/07-eeg-collection.html';
        }
      });
    </script>
  </body>
</html>
