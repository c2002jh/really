<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ìŒì•… í‰ê°€ - NeuroTune</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fjalla+One&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="../assets/css/common.css" />
    <link rel="stylesheet" href="07-eeg-collection.css" />
  </head>
  <body>
    <main class="page-wrapper">
      <!-- Background icon -->
      <img
        src="../../logo_page/icon/neurotune_icon.png"
        alt="NeuroTune background icon"
        class="bg-logo-icon"
      />

      <section class="evaluation-content">
        <!-- Progress indicator -->
        <div class="progress-bar">
          <div class="progress-text">
            <span id="currentSong">1</span> / <span id="totalSongs">18</span>
          </div>
          <div class="progress-track">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>

        <!-- Genre label -->
        <div class="genre-label" id="genreLabel">K-POP</div>

        <!-- Year Selection -->
        <div class="year-selection-container" style="margin-bottom: 20px; text-align: center;">
            <label for="yearSelect" style="color: white; margin-right: 10px;">ì—°ë„ ì„ íƒ:</label>
            <select id="yearSelect" class="year-select" style="padding: 5px 10px; border-radius: 5px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white;">
                <option value="2020-2025" style="color: black;">2020ë…„ëŒ€</option>
                <option value="2010-2019" style="color: black;">2010ë…„ëŒ€</option>
                <option value="2000-2009" style="color: black;">2000ë…„ëŒ€</option>
                <option value="1990-1999" style="color: black;">1990ë…„ëŒ€</option>
            </select>
        </div>

        <!-- Song info -->
        <div class="song-info fade-in">
          <div class="album-cover">
            <img id="albumCover" src="https://via.placeholder.com/300" alt="Album cover" />
          </div>

          <h2 class="song-title" id="songTitle">ê³¡ ì œëª©</h2>
          <p class="artist-name" id="artistName">ì•„í‹°ìŠ¤íŠ¸</p>
          
          <!-- Play/Pause and Like/Dislike Controls -->
          <div class="controls-container" style="margin-top: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px;">
            <div class="playback-controls">
                <button id="playPauseBtn" class="btn-control" style="padding: 8px 20px; border-radius: 20px; background: #1DB954; color: white; border: none; cursor: pointer; margin-right: 10px;">
                    â–¶ ì¬ìƒ
                </button>
                <button id="stopBtn" class="btn-control" style="padding: 8px 20px; border-radius: 20px; background: #e74c3c; color: white; border: none; cursor: pointer;">
                    â¹ ì •ì§€
                </button>
                <audio id="audioPreview" style="display: none;"></audio>
            </div>
            
            <div class="preference-controls" style="display: flex; gap: 15px;">
                <button id="likeBtn" class="btn-pref" data-value="like" style="padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; cursor: pointer;">
                    ğŸ‘ ì¢‹ìŒ
                </button>
                <button id="dislikeBtn" class="btn-pref" data-value="dislike" style="padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; cursor: pointer;">
                    ğŸ‘ ì‹«ìŒ
                </button>
            </div>
          </div>

          <button id="rerollBtn" class="btn-reroll" style="margin-top: 15px; padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; cursor: pointer;">
            ğŸ”„ ë‹¤ë¥¸ ë…¸ë˜ ì¶”ì²œë°›ê¸°
          </button>
        </div>

        <!-- File upload area -->
        <div class="upload-section">
          <p class="upload-instruction">EEG ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš” (4ê°œ íŒŒì¼)</p>
          
          <!-- Folder Upload Option -->
          <div class="folder-upload-container" style="text-align: center; margin-bottom: 20px;">
            <input type="file" id="folder-input" webkitdirectory directory multiple style="display: none;" />
            <button id="folderUploadBtn" class="btn-secondary" style="padding: 10px 20px; border-radius: 8px; cursor: pointer;">
              ğŸ“‚ í´ë” í†µì§¸ë¡œ ì—…ë¡œë“œí•˜ê¸°
            </button>
            <p style="font-size: 12px; color: #aaa; margin-top: 5px;">(Rawdata.txt, Fp1_FFT.txt, Fp2_FFT.txt, Biomarkers.txt íŒŒì¼ì´ í¬í•¨ëœ í´ë”)</p>
          </div>

          <div class="upload-grid">
            <div class="upload-box" data-file="rawdata">
              <input type="file" id="file-rawdata" accept=".txt" />
              <label for="file-rawdata">
                <div class="upload-icon">ğŸ“„</div>
                <span class="upload-label">Rawdata.txt</span>
                <span class="upload-status"></span>
              </label>
            </div>

            <div class="upload-box" data-file="fp1">
              <input type="file" id="file-fp1" accept=".txt" />
              <label for="file-fp1">
                <div class="upload-icon">ğŸ“„</div>
                <span class="upload-label">Fp1_FFT.txt</span>
                <span class="upload-status"></span>
              </label>
            </div>

            <div class="upload-box" data-file="fp2">
              <input type="file" id="file-fp2" accept=".txt" />
              <label for="file-fp2">
                <div class="upload-icon">ğŸ“„</div>
                <span class="upload-label">Fp2_FFT.txt</span>
                <span class="upload-status"></span>
              </label>
            </div>

            <div class="upload-box" data-file="biomarkers">
              <input type="file" id="file-biomarkers" accept=".txt" />
              <label for="file-biomarkers">
                <div class="upload-icon">ğŸ“„</div>
                <span class="upload-label">Biomarkers.txt</span>
                <span class="upload-status"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Next song button -->
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn next-song-btn" id="nextSongBtn" disabled>
            ë‹¤ìŒ ê³¡
            </button>
            <div style="margin-top: 10px;">
                <label style="font-size: 12px; color: #666; cursor: pointer;">
                    <input type="checkbox" id="useAiAnalysis" onchange="toggleAiToken()"> 
                    AI ì‹¬ì¸µ ë¶„ì„ (GitHub Token í•„ìš”)
                </label>
            </div>
        </div>

        <!-- Loading overlay -->
        <div class="loading-overlay" id="loadingOverlay" style="display: none">
          <div class="loading"></div>
          <p>EEG ë°ì´í„° ë¶„ì„ ì¤‘...</p>
        </div>
      </section>
    </main>

    <script>
      const API_BASE_URL = 'http://localhost:5000/api';

      // [DEBUG] í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ê°ì§€ (Live Serverê°€ íŒŒì¼ ë³€ê²½ìœ¼ë¡œ ì¸í•´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ëŠ”ì§€ í™•ì¸)
      window.addEventListener('beforeunload', (e) => {
          console.warn('âš ï¸ í˜ì´ì§€ê°€ ìƒˆë¡œê³ ì¹¨/ì¢…ë£Œë˜ê³  ìˆìŠµë‹ˆë‹¤! ì§„í–‰ ì¤‘ì¸ ìš”ì²­ì´ ì·¨ì†Œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      });

      let currentSongIndex = 0;
      let songs = [];
      let uploadedFiles = {};
      let evaluationData = [];

      document.addEventListener('DOMContentLoaded', async () => {
        const likedGenres = JSON.parse(localStorage.getItem('neurotune_likedGenres') || localStorage.getItem('neurotune_genres') || '["pop"]');
        const userId = localStorage.getItem('neurotune_userId') || 'anonymous';

        // Load songs for evaluation (3 songs per genre)
        await loadSongsForEvaluation(likedGenres);

        // Initialize UI
        updateUI();

        // Set up file upload handlers
        setupFileUploads();

        // Set up next button
        document.getElementById('nextSongBtn').addEventListener('click', handleNextSong);
        
        // Set up Reroll button
        document.getElementById('rerollBtn').addEventListener('click', fetchRandomSong);
        
        // Play/Pause logic is now handled inside displaySong to support both modes
        
        // Set up Like/Dislike
        document.querySelectorAll('.btn-pref').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const value = e.target.dataset.value;
                currentLikeStatus = value;
                
                // Update UI
                document.querySelectorAll('.btn-pref').forEach(b => {
                    b.style.background = 'rgba(255,255,255,0.2)';
                });
                e.target.style.background = value === 'like' ? '#1DB954' : '#E91E63';
            });
        });
      });

      async function loadSongsForEvaluation(genres) {
        songs = [];
        genres.forEach(genre => {
            // 3 songs per genre
            for (let i = 0; i < 3; i++) {
                songs.push({
                    genre: genre,
                    title: 'Loading...',
                    artist: 'Loading...',
                    albumCover: 'https://via.placeholder.com/300',
                    id: null
                });
            }
        });
        document.getElementById('totalSongs').textContent = songs.length;
      }

      async function fetchRandomSong() {
          const currentSong = songs[currentSongIndex];
          // Ensure genre and year have valid values
          const genre = currentSong.genre || 'pop';
          const yearSelect = document.getElementById('yearSelect');
          const yearRange = yearSelect ? yearSelect.value : '2020-2025';
          
          console.log(`Fetching song for Genre: ${genre}, Year: ${yearRange}`);

          // Show loading state
          document.getElementById('songTitle').textContent = 'ë…¸ë˜ë¥¼ ì°¾ëŠ” ì¤‘...';
          document.getElementById('artistName').textContent = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”';
          document.getElementById('albumCover').style.opacity = '0.5';
          
          try {
              const response = await fetch(`${API_BASE_URL}/music/random-track?genre=${encodeURIComponent(genre)}&year=${yearRange}`);
              if (response.ok) {
                  const result = await response.json();
                  const track = result.data;
                  
                  currentSong.id = track.id;
                  currentSong.title = track.name;
                  currentSong.artist = track.artists[0].name;
                  currentSong.albumCover = track.album.images[0].url;
                  currentSong.previewUrl = track.preview_url;
                  currentSong.spotifyUri = track.uri; // Store Spotify URI
                  
                  displaySong(currentSong);
              } else {
                  console.error('Failed to fetch song');
                  document.getElementById('songTitle').textContent = 'ë…¸ë˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                  document.getElementById('artistName').textContent = 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”';
              }
          } catch (error) {
              console.error('Error:', error);
              document.getElementById('songTitle').textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
          } finally {
              document.getElementById('albumCover').style.opacity = '1';
          }
      }

      function displaySong(song) {
          document.getElementById('songTitle').textContent = song.title;
          document.getElementById('artistName').textContent = song.artist;
          document.getElementById('albumCover').src = song.albumCover;
          
          // Reset controls
          const audio = document.getElementById('audioPreview');
          const playBtn = document.getElementById('playPauseBtn');
          const stopBtn = document.getElementById('stopBtn');
          
          audio.pause();
          audio.currentTime = 0;
          
          // Remove old event listeners by cloning
          const newPlayBtn = playBtn.cloneNode(true);
          playBtn.parentNode.replaceChild(newPlayBtn, playBtn);
          
          const newStopBtn = stopBtn.cloneNode(true);
          stopBtn.parentNode.replaceChild(newStopBtn, stopBtn);
          
          if (song.previewUrl) {
              // Preview mode
              newPlayBtn.textContent = 'â–¶ ì¬ìƒ';
              newPlayBtn.disabled = false;
              newPlayBtn.style.opacity = '1';
              newPlayBtn.style.background = '#1DB954';
              newStopBtn.style.display = 'inline-block';
              
              audio.src = song.previewUrl;
              
              newPlayBtn.addEventListener('click', () => {
                  if (audio.paused) {
                      audio.play();
                      newPlayBtn.textContent = 'â¸ ì¼ì‹œì •ì§€';
                  } else {
                      audio.pause();
                      newPlayBtn.textContent = 'â–¶ ì¬ìƒ';
                  }
              });
              
              newStopBtn.addEventListener('click', () => {
                  audio.pause();
                  audio.currentTime = 0;
                  newPlayBtn.textContent = 'â–¶ ì¬ìƒ';
              });
              
              audio.onended = () => {
                  newPlayBtn.textContent = 'â–¶ ì¬ìƒ';
              };
          } else {
              // Spotify App mode
              newPlayBtn.textContent = 'Spotify ì•±ì—ì„œ ì¬ìƒ';
              newPlayBtn.disabled = false;
              newPlayBtn.style.opacity = '1';
              newPlayBtn.style.background = '#191414'; // Spotify Black
              newStopBtn.style.display = 'none'; // Cannot stop external app
              
              newPlayBtn.addEventListener('click', () => {
                  if (song.spotifyUri) {
                      window.location.href = song.spotifyUri;
                  } else {
                      alert('Spotify ì—°ê²° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                  }
              });
          }
          
          // Reset like/dislike buttons
          document.querySelectorAll('.btn-pref').forEach(btn => {
              btn.style.background = 'rgba(255,255,255,0.2)';
          });
          currentLikeStatus = 'none';
      }

      let currentLikeStatus = 'none';

      async function updateUI() {
        const currentSong = songs[currentSongIndex];
        document.getElementById('currentSong').textContent = currentSongIndex + 1;
        
        const progressPercent = ((currentSongIndex) / songs.length) * 100;
        document.getElementById('progressFill').style.width = `${progressPercent}%`;

        document.getElementById('genreLabel').textContent = currentSong.genre.toUpperCase();
        
        // If the song hasn't been fetched yet, fetch it
        if (!currentSong.id) {
            await fetchRandomSong();
        } else {
            displaySong(currentSong);
        }
        
        // Reset file inputs
        document.querySelectorAll('.upload-box input[type="file"]').forEach(input => {
          input.value = '';
          const label = input.nextElementSibling;
          if (label) {
              const status = label.querySelector('.upload-status');
              if (status) status.textContent = '';
              label.classList.remove('uploaded');
          }
        });
        uploadedFiles = {};
        updateNextButton();
      }

      function setupFileUploads() {
        // Individual file inputs
        const fileInputs = ['rawdata', 'fp1', 'fp2', 'biomarkers'];

        fileInputs.forEach(fileType => {
          const input = document.getElementById(`file-${fileType}`);
          const box = document.querySelector(`.upload-box[data-file="${fileType}"]`);

          input.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
              uploadedFiles[fileType] = file;
              box.classList.add('uploaded');
              box.querySelector('.upload-status').textContent = file.name;
              updateNextButton();
            }
          });
        });

        // Folder upload
        const folderBtn = document.getElementById('folderUploadBtn');
        const folderInput = document.getElementById('folder-input');

        folderBtn.addEventListener('click', () => {
            folderInput.click();
        });

        folderInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            let matchCount = 0;

            files.forEach(file => {
                const name = file.name.toLowerCase();
                let type = null;

                if (name === 'rawdata.txt') type = 'rawdata';
                else if (name === 'fp1_fft.txt') type = 'fp1';
                else if (name === 'fp2_fft.txt') type = 'fp2';
                else if (name === 'biomarkers.txt') type = 'biomarkers';

                if (type) {
                    uploadedFiles[type] = file;
                    const box = document.querySelector(`.upload-box[data-file="${type}"]`);
                    box.classList.add('uploaded');
                    box.querySelector('.upload-status').textContent = file.name;
                    matchCount++;
                }
            });

            if (matchCount > 0) {
                alert(`${matchCount}ê°œì˜ íŒŒì¼ì´ ìë™ìœ¼ë¡œ ì¸ì‹ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                alert('ì§€ì •ëœ íŒŒì¼(Rawdata.txt, Fp1_FFT.txt, Fp2_FFT.txt, Biomarkers.txt)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            updateNextButton();
        });
      }

      function updateNextButton() {
        const allFilesUploaded = ['rawdata', 'fp1', 'fp2', 'biomarkers'].every(
          type => uploadedFiles[type]
        );

        document.getElementById('nextSongBtn').disabled = !allFilesUploaded;
      }

      function toggleAiToken() {
          const checkbox = document.getElementById('useAiAnalysis');
          if (checkbox.checked) {
              const token = prompt('GitHub Personal Access Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”:\n(AI ëª¨ë¸ ì‚¬ìš©ì„ ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤)');
              if (token) {
                  localStorage.setItem('neurotune_githubToken', token);
              } else {
                  checkbox.checked = false;
              }
          } else {
              localStorage.removeItem('neurotune_githubToken');
          }
      }

      async function handleNextSong() {
        console.log('handleNextSong started');
        const userId = localStorage.getItem('neurotune_userId') || 'anonymous';
        const currentSong = songs[currentSongIndex];

        if (!currentSong) {
            alert('ê³¡ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // Show loading overlay
        document.getElementById('loadingOverlay').style.display = 'flex';

        try {
          console.log('Preparing form data...');
          // Prepare form data
          const formData = new FormData();
          formData.append('eeg1', uploadedFiles['rawdata']);
          formData.append('eeg2', uploadedFiles['fp1']);
          formData.append('ecg', uploadedFiles['fp2']);
          formData.append('gsr', uploadedFiles['biomarkers']);
          formData.append('userId', userId);
          // Add song metadata
          formData.append('songTitle', currentSong.title || 'Unknown');
          formData.append('artistName', currentSong.artist || 'Unknown');
          formData.append('likeStatus', currentLikeStatus || 'none');

          // Check for GitHub Token (Optional AI Analysis)
          const githubToken = localStorage.getItem('neurotune_githubToken');
          if (githubToken) {
              formData.append('githubToken', githubToken);
          }

          console.log('Sending request to:', `${API_BASE_URL}/analyze`);
          // Send to backend for analysis
          const response = await fetch(`${API_BASE_URL}/analyze`, {
            method: 'POST',
            body: formData
          });

          console.log('Response received. Status:', response.status);

          if (response.ok) {
            const text = await response.text();
            console.log('Raw response text:', text);
            
            let result;
            try {
                result = JSON.parse(text);
            } catch (e) {
                throw new Error(`JSON Parsing Error: ${e.message}. Response: ${text.substring(0, 100)}...`);
            }

            console.log('Parsed result:', result);
            
            if (!result.data || !result.data.results) {
                throw new Error('Invalid analysis result format: data or results missing');
            }

            // Store evaluation data
            console.log('Storing evaluation data...');
            evaluationData.push({
              songId: currentSong.id,
              genre: currentSong.genre,
              results: result.data.results
            });

            // Move to next song or finish
            currentSongIndex++;
            console.log('Moving to next song. Index:', currentSongIndex);

            if (currentSongIndex < songs.length) {
              // Hide loading and show next song
              document.getElementById('loadingOverlay').style.display = 'none';
              console.log('Calling updateUI...');
              await updateUI(); // Added await to catch errors in updateUI
            } else {
              // All songs evaluated, go to main page
              console.log('All songs evaluated. Redirecting...');
              localStorage.setItem('neurotune_evaluationComplete', 'true');
              window.location.href = '../main-page/08-main.html';
            }
          } else {
            const errorText = await response.text();
            throw new Error(`Analysis failed: ${response.status} ${errorText}`);
          }
        } catch (error) {
          console.error('Error analyzing EEG data:', error);
          console.error('Error details:', {
              message: error.message,
              name: error.name,
              stack: error.stack
          });
          alert(`ì˜¤ë¥˜ ë°œìƒ!\n\në©”ì‹œì§€: ${error.message}\n\n(ì½˜ì†”(F12)ì„ í™•ì¸í•˜ì—¬ ìƒì„¸ ë¡œê·¸ë¥¼ ìº¡ì²˜í•´ì£¼ì„¸ìš”)`);
          document.getElementById('loadingOverlay').style.display = 'none';
        }
      }
    </script>
  </body>
</html>
